# nfs-jogger

A distributed NFS filesystem walker for massive data migrations and indexing. Built on top of nfs-walker, nfs-jogger scales horizontally by distributing work across multiple nodes using Redis for coordination.

## Overview

nfs-jogger operates in two phases:

1. **Discovery Phase**: Scans the NFS filesystem and creates "bundles" of work (sets of file paths)
2. **Processing Phase**: Workers pull bundles from a Redis queue and process them in parallel

This architecture allows you to scale processing by simply adding more worker nodes.

## Features

- **Horizontal Scaling**: Add more VMs or bare metal hosts to increase throughput
- **Work Distribution**: Automatic load balancing through Redis queue
- **Fault Tolerance**: Failed bundles can be retried; workers can restart without losing progress
- **Configurable Bundle Sizes**: Control bundle size by path count (default: 2000) or total bytes (default: 2TB)
- **Progress Monitoring**: Real-time status of queue and workers
- **Graceful Shutdown**: Ctrl+C triggers graceful shutdown, allowing current work to complete

## Prerequisites

- Rust toolchain (1.70+)
- libnfs development libraries
- Redis server (for coordination)
- Access to NFS exports

## Installation

```bash
cd nfs-jogger
cargo build --release
```

## Usage

### Starting the Discovery Phase

The discovery phase scans the filesystem and creates work bundles:

```bash
# Basic discovery
nfs-jogger discover nfs://server/export --redis redis://localhost:6379

# With custom bundle sizes
nfs-jogger discover nfs://server/export \
    --max-paths 5000 \
    --max-size 1TB \
    --workers 16

# Exclude patterns
nfs-jogger discover nfs://server/export \
    --exclude '.snapshot' \
    --exclude '\.tmp$'

# Limit depth
nfs-jogger discover nfs://server/export --max-depth 10
```

### Starting Workers

Workers pull bundles from the queue and process them:

```bash
# Start a worker
nfs-jogger work --redis redis://localhost:6379 -o results.db

# Run continuously (don't exit when queue is empty)
nfs-jogger work --redis redis://localhost:6379 -o results.db --continuous

# Specify worker ID (auto-generated by default)
nfs-jogger work --redis redis://localhost:6379 -o results.db --worker-id worker-1

# Use multiple local threads
nfs-jogger work --redis redis://localhost:6379 -o results.db --workers 8
```

### Monitoring Status

Check the status of the distributed system:

```bash
# One-time status check
nfs-jogger status --redis redis://localhost:6379

# Watch mode (continuous updates)
nfs-jogger status --redis redis://localhost:6379 --watch

# JSON output
nfs-jogger status --redis redis://localhost:6379 --format json
```

### Managing the Queue

```bash
# Reset the queue (clear pending/failed bundles)
nfs-jogger reset --redis redis://localhost:6379

# Reset everything including completed records
nfs-jogger reset --redis redis://localhost:6379 --all

# Retry all failed bundles
nfs-jogger retry --redis redis://localhost:6379 --all

# Retry a specific bundle
nfs-jogger retry --redis redis://localhost:6379 <bundle-id>
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           nfs-jogger                                    │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                     Discovery Phase                               │  │
│  │  nfs-jogger discover nfs://server/export                         │  │
│  │                                                                   │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │  │
│  │  │  Worker 0   │    │  Worker 1   │    │  Worker N   │          │  │
│  │  │ READDIRPLUS │    │ READDIRPLUS │    │ READDIRPLUS │          │  │
│  │  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘          │  │
│  │         └──────────────────┼──────────────────┘                  │  │
│  │                            │                                      │  │
│  │                     ┌──────▼──────┐                              │  │
│  │                     │   Bundler   │                              │  │
│  │                     │ 2000 paths  │                              │  │
│  │                     │   or 2TB    │                              │  │
│  │                     └──────┬──────┘                              │  │
│  └────────────────────────────┼──────────────────────────────────────┘  │
│                               │                                         │
│                        ┌──────▼──────┐                                 │
│                        │    Redis    │                                 │
│                        │   Queue     │                                 │
│                        └──────┬──────┘                                 │
│                               │                                         │
│  ┌────────────────────────────┼──────────────────────────────────────┐  │
│  │                     Processing Phase                              │  │
│  │  nfs-jogger work (on multiple nodes)                             │  │
│  │                            │                                      │  │
│  │         ┌──────────────────┼──────────────────┐                  │  │
│  │         │                  │                  │                  │  │
│  │  ┌──────▼──────┐    ┌──────▼──────┐    ┌──────▼──────┐          │  │
│  │  │  Worker A   │    │  Worker B   │    │  Worker C   │          │  │
│  │  │   Host 1    │    │   Host 2    │    │   Host 3    │          │  │
│  │  │             │    │             │    │             │          │  │
│  │  │ Pull bundle │    │ Pull bundle │    │ Pull bundle │          │  │
│  │  │ Process     │    │ Process     │    │ Process     │          │  │
│  │  │ Write DB    │    │ Write DB    │    │ Write DB    │          │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘          │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## Bundle Structure

Each bundle contains:

- **Metadata**: Bundle ID, creation time, NFS server/export info, state
- **Paths**: List of file/directory paths to process (up to 2000 by default)
- **Statistics**: File count, directory count, total estimated bytes

Bundles are serialized as JSON and stored in Redis with a 7-day TTL.

## Configuration Options

### Discovery Options

| Option | Default | Description |
|--------|---------|-------------|
| `--max-paths` | 2000 | Maximum paths per bundle |
| `--max-size` | 2TB | Maximum total size per bundle |
| `--workers` | CPU×2 | Number of discovery workers |
| `--max-depth` | unlimited | Maximum directory depth |
| `--exclude` | none | Regex patterns to exclude |
| `--timeout` | 30s | NFS connection timeout |
| `--dirs-only` | false | Only bundle directories |

### Worker Options

| Option | Default | Description |
|--------|---------|-------------|
| `-o, --output` | walk.db | Output database file |
| `--workers` | CPU×2 | Number of local worker threads |
| `--worker-id` | auto | Worker identifier |
| `--continuous` | false | Keep running when queue is empty |
| `--max-bundles` | unlimited | Max bundles to process |
| `--timeout` | 30s | NFS connection timeout |
| `--retries` | 3 | Retry count for errors |

### Global Options

| Option | Default | Description |
|--------|---------|-------------|
| `--redis` | redis://127.0.0.1:6379 | Redis URL |
| `-q, --quiet` | false | Suppress progress output |
| `-v, --verbose` | false | Verbose logging |

## Redis Keys

nfs-jogger uses the following Redis keys:

- `nfs-jogger:bundles:queue` - Redis Stream for pending bundles
- `nfs-jogger:bundles:processing` - Set of bundles being processed
- `nfs-jogger:bundles:completed` - Set of completed bundle IDs
- `nfs-jogger:bundles:failed` - Set of failed bundle IDs
- `nfs-jogger:bundle:<id>` - Individual bundle data (JSON)
- `nfs-jogger:workers:heartbeat:<id>` - Worker heartbeat timestamps
- `nfs-jogger:stats` - Global statistics hash

## Scaling Guidelines

1. **Start with discovery**: Run one discovery process initially
2. **Add workers**: Start workers on multiple hosts pointing to the same Redis
3. **Monitor progress**: Use `nfs-jogger status --watch` to monitor
4. **Handle failures**: Use `nfs-jogger retry --all` to retry failed bundles

### Recommended Configurations

**Small filesystem (< 10M files)**:
- 1 discovery process, 2-4 workers

**Medium filesystem (10M-100M files)**:
- 1-2 discovery processes, 8-16 workers

**Large filesystem (100M+ files)**:
- Multiple discovery processes on different subtrees
- 32+ workers across multiple hosts
- Consider increasing bundle sizes

## Comparison with nfs-walker

| Feature | nfs-walker | nfs-jogger |
|---------|------------|------------|
| Single-node | ✓ | ✓ |
| Multi-node | ✗ | ✓ |
| Requires Redis | ✗ | ✓ |
| Fault tolerance | Limited | Full |
| Scalability | Vertical | Horizontal |
| Use case | Quick scans | Large migrations |

## License

MIT License - See LICENSE file for details.
